// Copyright 2026 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#if canImport(FoundationModels)
  import FoundationModels

  @available(iOS 26.0, macOS 26.0, *)
  @available(tvOS, unavailable)
  @available(watchOS, unavailable)
  public extension FirebaseAI {
    /// Structured content generated by a model.
    ///
    /// **Public Preview**: This API is a public preview and may be subject to change.
    struct GeneratedContent: Sendable, Equatable, CustomDebugStringConvertible {
      let wrapped: FoundationModels.GeneratedContent

      /// The generation identifier associated with this content, if any.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      public let generationID: FirebaseAI.GenerationID?

      /// Creates a new ``GeneratedContent`` from a JSON string.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      ///
      /// - Parameters:
      ///   - json: The JSON string representation of the generated content.
      /// - Throws: An error if the JSON is invalid.
      public init(json: String) throws {
        wrapped = try FoundationModels.GeneratedContent(json: json)
        generationID = nil
      }

      init(json: String, id: FirebaseAI.GenerationID?) throws {
        var generatedContent = try FoundationModels.GeneratedContent(json: json)
        generatedContent.id = id?.generationID
        wrapped = generatedContent
        generationID = id
      }

      init(kind: FoundationModels.GeneratedContent.Kind, id: FirebaseAI.GenerationID? = nil) {
        wrapped = FoundationModels.GeneratedContent(kind: kind, id: id?.generationID)
        generationID = id
      }

      /// The JSON string representation of the generated content.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      public var jsonString: String { wrapped.jsonString }

      // TODO: Replace `ConvertibleFromGeneratedContent` with custom protocol

      /// Decodes the generated content into the specified type.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      ///
      /// - Parameters:
      ///   - type: The type to decode the content into.
      /// - Returns: The decoded value.
      /// - Throws: An error if decoding fails.
      public func value<Value>(_ type: Value.Type = Value.self) throws -> Value
        where Value: FoundationModels.ConvertibleFromGeneratedContent {
        return try wrapped.value(type)
      }

      /// Decodes a specific property of the generated content into the specified type.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      ///
      /// - Parameters:
      ///   - type: The type to decode the property into.
      ///   - property: The name of the property to decode.
      /// - Returns: The decoded value.
      /// - Throws: An error if decoding fails or the property does not exist.
      public func value<Value>(_ type: Value.Type = Value.self,
                               forProperty property: String) throws -> Value
        where Value: FoundationModels.ConvertibleFromGeneratedContent {
        return try wrapped.value(type, forProperty: property)
      }

      /// Decodes an optional specific property of the generated content into the specified type.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      ///
      /// - Parameters:
      ///   - type: The optional type to decode the property into.
      ///   - property: The name of the property to decode.
      /// - Returns: The decoded value, or `nil` if the property does not exist or is null.
      /// - Throws: An error if decoding fails.
      public func value<Value>(_ type: Value?.Type = Value?.self,
                               forProperty property: String) throws -> Value?
        where Value: FoundationModels.ConvertibleFromGeneratedContent {
        return try wrapped.value(type, forProperty: property)
      }

      /// A debug description of the generated content.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      public var debugDescription: String { wrapped.debugDescription }

      /// A boolean indicating whether the generated content is complete.
      ///
      /// **Public Preview**: This API is a public preview and may be subject to change.
      public var isComplete: Bool { wrapped.isComplete }
    }
  }

  @available(iOS 26.0, macOS 26.0, *)
  @available(tvOS, unavailable)
  @available(watchOS, unavailable)
  public extension FirebaseAI.GeneratedContent {
    /// The kinds of values that can be represented by generated content.
    ///
    /// **Public Preview**: This API is a public preview and may be subject to change.
    enum Kind: Equatable, Sendable {
      /// A null value.
      case null
      /// A boolean value.
      case bool(Bool)
      /// A number value.
      case number(Double)
      /// A string value.
      case string(String)
      /// An array of generated content values.
      case array([FirebaseAI.GeneratedContent])
      /// A structure with properties and ordered keys.
      case structure(properties: [String: FirebaseAI.GeneratedContent], orderedKeys: [String])
    }

    /// The kind of value represented by this generated content.
    var kind: FirebaseAI.GeneratedContent.Kind {
      switch wrapped.kind {
      case .null:
        return .null
      case let .bool(value):
        return .bool(value)
      case let .number(value):
        return .number(value)
      case let .string(value):
        return .string(value)
      case let .array(values):
        return .array(values.map { FirebaseAI.GeneratedContent(kind: $0.kind, id: nil) })
      case let .structure(properties, orderedKeys):
        return .structure(
          properties: properties.mapValues { FirebaseAI.GeneratedContent(kind: $0.kind, id: nil) },
          orderedKeys: orderedKeys
        )
      @unknown default:
        assertionFailure("Unknown `FoundationModels.GeneratedContent` kind: \(wrapped.kind)")
        return .null
      }
    }
  }
#endif // canImport(FoundationModels)
